#!/usr/bin/env bash -x

./clean.sh

./refresh-security-measurement-files.sh

perl daysofrisk.pl --cpe jboss_enterprise_application_platform:7 --dates 20140211- --xmlsummary EAP7-resolved-issues-post-wildfly-8.0.0.Final-release-date.xml > EAP7-resolved-issues-post-wildfly-8.0.0.Final-release-date.txt

perl daysofrisk.pl --cpe jboss_enterprise_application_platform:7 --dates 20140530- --xmlsummary EAP7-resolved-issues-post-wildfly-8.1.0.Final-release-date.xml > EAP7-resolved-issues-post-wildfly-8.1.0.Final-release-date.txt

perl daysofrisk.pl --cpe jboss_enterprise_application_platform:7 --dates 20141120- --xmlsummary EAP7-resolved-issues-post-wildfly-8.2.0.Final-release-date.xml > EAP7-resolved-issues-post-wildfly-8.2.0.Final-release-date.txt

perl daysofrisk.pl --cpe jboss_enterprise_application_platform:7 --dates 20150723- --xmlsummary EAP7-resolved-issues-post-wildfly-8.2.1.Final-release-date.xml > EAP7-resolved-issues-post-wildfly-8.2.1.Final-release-date.txt

perl daysofrisk.pl --cpe jboss_enterprise_application_platform:7 --dates 20150702- --xmlsummary EAP7-resolved-issues-post-wildfly-9.0.0.Final-release-date.xml > EAP7-resolved-issues-post-wildfly-9.0.0.Final-release-date.txt

perl daysofrisk.pl --cpe jboss_enterprise_application_platform:7 --dates 20150723- --xmlsummary EAP7-resolved-issues-post-wildfly-9.0.1.Final-release-date.xml > EAP7-resolved-issues-post-wildfly-9.0.1.Final-release-date.txt

perl daysofrisk.pl --cpe jboss_enterprise_application_platform:7 --dates 20160130- --xmlsummary EAP7-resolved-issues-post-wildfly-10.0.0.Final-release-date.xml > EAP7-resolved-issues-post-wildfly-10.0.0.Final-release-date.txt

perl daysofrisk.pl --cpe jboss_enterprise_application_platform:7 --dates 20160820- --xmlsummary EAP7-resolved-issues-post-wildfly-10.1.0.Final-release-date.xml > EAP7-resolved-issues-post-wildfly-10.1.0.Final-release-date.txt

perl daysofrisk.pl --cpe jboss_enterprise_application_platform:7 --dates 20170328- --xmlsummary EAP7-resolved-issues-post-wildfly-11.0.0.Alpha1-release-date.xml > EAP7-resolved-issues-post-wildfly-11.0.0.Alpha1-release-date.txt

perl daysofrisk.pl --cpe jboss_enterprise_application_platform:7 --dates 20170803- --xmlsummary EAP7-resolved-issues-post-wildfly-11.0.0.Beta1-release-date.xml > EAP7-resolved-issues-post-wildfly-11.0.0.Beta1-release-date.txt

perl daysofrisk.pl --cpe jboss_enterprise_application_platform:7 --dates 20170825- --xmlsummary EAP7-resolved-issues-post-wildfly-11.0.0.CR1-release-date.xml > EAP7-resolved-issues-post-wildfly-11.0.0.CR1-release-date.txt

perl daysofrisk.pl --cpe jboss_enterprise_application_platform:7 --dates 20171023- --xmlsummary EAP7-resolved-issues-post-wildfly-11.0.0.Final-release-date.xml > EAP7-resolved-issues-post-wildfly-11.0.0.Final-release-date.txt

perl daysofrisk.pl --cpe jboss_enterprise_application_platform:7 --dates 20180228- --xmlsummary EAP7-resolved-issues-post-wildfly-12.0.0.Final-release-date.xml > EAP7-resolved-issues-post-wildfly-12.0.0.Final-release-date.txt

perl daysofrisk.pl --cpe jboss_enterprise_application_platform:7 --dates 20180517- --xmlsummary EAP7-resolved-issues-post-wildfly-13.0.0.Beta1-release-date.xml > EAP7-resolved-issues-post-wildfly-13.0.0.Beta1-release-date.txt

perl daysofrisk.pl --cpe jboss_enterprise_application_platform:7 --dates 20180530- --xmlsummary EAP7-resolved-issues-post-wildfly-13.0.0.Final-release-date.xml > EAP7-resolved-issues-post-wildfly-13.0.0.Final-release-date.txt

perl daysofrisk.pl --cpe jboss_enterprise_application_platform:7 --dates 20180830- --xmlsummary EAP7-resolved-issues-post-wildfly-14.0.0.Final-release-date.xml > EAP7-resolved-issues-post-wildfly-14.0.0.Final-release-date.txt

perl daysofrisk.pl --cpe jboss_enterprise_application_platform:7 --dates 20180905- --xmlsummary EAP7-resolved-issues-post-wildfly-14.0.1.Final-release-date.xml > EAP7-resolved-issues-post-wildfly-14.0.1.Final-release-date.txt

perl daysofrisk.pl --cpe jboss_enterprise_application_platform:7 --dates 20181130- --xmlsummary EAP7-resolved-issues-post-wildfly-15.0.0.Final-release-date.xml > EAP7-resolved-issues-post-wildfly-15.0.0.Final-release-date.txt

perl daysofrisk.pl --cpe jboss_enterprise_application_platform:7 --dates 20190105- --xmlsummary EAP7-resolved-issues-post-wildfly-15.0.1.Final-release-date.xml > EAP7-resolved-issues-post-wildfly-15.0.1.Final-release-date.txt

perl daysofrisk.pl --cpe jboss_enterprise_application_platform:7 --dates 20190213- --xmlsummary EAP7-resolved-issues-post-wildfly-16.0.0.Beta1-release-date.xml > EAP7-resolved-issues-post-wildfly-16.0.0.Beta1-release-date.txt

cat > table-data.html <<EOF1
<table>
<tr><th rowspan="2">WildFly Release</th><th colspan="5">Minimum Number of CVEs</th></tr>
<tr><th>Critical</th><th>Important</th><th>Moderate</th><th>Low</th><th>Total</th></tr>
EOF1
for i in $(ls -t EAP*.txt)
do
    WF_RELEASE=$(echo $i | cut -d\- -f6)

    CRITICAL=$(grep vulnerabilities $i | grep 'C=' | sed 's/..*C=\([0-9][0-9]*\)..*/\1/g')
    LINK="EAP7-resolved-issues-post-wildfly-$WF_RELEASE-release-date.html"
    IMPORTANT=$(grep vulnerabilities $i | grep 'I=' | sed 's/..*I=\([0-9][0-9]*\)..*/\1/g')
    MODERATE=$(grep vulnerabilities $i | grep 'M=' | sed 's/..*M=\([0-9][0-9]*\)..*/\1/g')
    LOW=$(grep vulnerabilities $i | grep 'L=' | sed 's/..*L=\([0-9][0-9]*\)..*/\1/g')

    TOTAL=$(grep vulnerabilities $i | awk '{print $2}')

    echo "<tr><td><a href=\"$LINK\">$WF_RELEASE</a></td><td>$CRITICAL</td><td>$IMPORTANT</td><td>$MODERATE</td><td>$LOW</td><td>$TOTAL</td></tr>" >> table-data.html
done
echo "</table>" >> table-data.html

cat header-eap7_v_wildfly.html table-data.html footer-eap7_v_wildfly.html > eap7_v_wildfly.html
rm -f table-data.html

for i in 8.0.0.Final 8.1.0.Final 8.2.0.Final 8.2.1.Final 9.0.0.Final 9.0.1.Final 10.0.0.Final 10.1.0.Final 11.0.0.Alpha1 11.0.0.Beta1 11.0.0.CR1 11.0.0.Final 12.0.0.Final 13.0.0.Beta1 13.0.0.Final 14.0.0.Final 14.0.1.Final 15.0.0.Final 15.0.1.Final 16.0.0.Beta1
do
    xsltproc html-report.xsl EAP7-resolved-issues-post-wildfly-$i-release-date.xml > EAP7-resolved-issues-post-wildfly-$i-release-date.html
done

# this is for updates to the people.redhat.com server
scp *.html *.xsl rlucente@people.redhat.com:public_html

